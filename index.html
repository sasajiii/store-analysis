<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº—èˆ—åˆ†æã‚¢ãƒ—ãƒª - ä¿®æ­£ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .content {
            padding: 30px;
        }
        .upload-area {
            background: #f8fafc;
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }
        .upload-area:hover {
            border-color: #667eea;
            background: #f0f9ff;
        }
        .btn {
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #059669;
        }
        .tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .filters {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        .filter-label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #374151;
            font-size: 0.9rem;
        }
        .filter-control {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
        }
        .rankings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .ranking-section {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .ranking-title {
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }
        .ranking-title.up { color: #10b981; }
        .ranking-title.down { color: #ef4444; }
        .ranking-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ranking-item.up { border-left: 4px solid #10b981; }
        .ranking-item.down { border-left: 4px solid #ef4444; }
        .store-name {
            font-weight: 600;
        }
        .store-details {
            font-size: 0.85rem;
            color: #64748b;
        }
        .score-change {
            font-weight: bold;
            font-size: 1.1rem;
        }
        .score-change.positive { color: #10b981; }
        .score-change.negative { color: #ef4444; }
        .canvas-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            padding: 4px 8px;
            background: #f8fafc;
            border-radius: 4px;
        }
        .legend-color {
            width: 16px;
            height: 3px;
            border-radius: 2px;
        }
        .debug-area {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>åº—èˆ—åˆ†æã‚¢ãƒ—ãƒªï¼ˆä¿®æ­£ç‰ˆï¼‰</h1>
            <p>æ»‘ã‚‰ã‹ãªã‚°ãƒ©ãƒ•ãƒ»3.0-4.0ç¯„å›²ãƒ»ã‚¸ãƒ£ãƒ³ãƒ«è¡¨ç¤ºå¯¾å¿œ</p>
        </div>
        
        <div class="content">
            <div class="upload-area">
                <div style="font-size: 2rem; margin-bottom: 15px;">ğŸ“</div>
                <h3 style="margin-bottom: 10px;">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                <p style="color: #64748b; margin-bottom: 20px;">åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                <input type="file" id="fileInput" accept=".csv" style="display: none;">
                <button class="btn" onclick="document.getElementById('fileInput').click()">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
            </div>
            
            <div id="results" class="hidden">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('ranking')">ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°åˆ†æ</button>
                    <button class="tab" onclick="switchTab('graph')">ğŸ“ˆ ã‚°ãƒ©ãƒ•åˆ†æ</button>
                </div>
                
                <div id="ranking-content" class="tab-content active">
                    <div class="filters">
                        <div class="filter-group">
                            <label class="filter-label">åº—åã§æ¤œç´¢</label>
                            <input type="text" class="filter-control" id="searchBox" placeholder="åº—åã‚’å…¥åŠ›..." oninput="applyFilters()">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">çœŒ</label>
                            <select class="filter-control" id="prefectureSelect" onchange="applyFilters()">
                                <option value="">ã™ã¹ã¦</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">ä¾¡æ ¼å¸¯</label>
                            <select class="filter-control" id="priceSelect" onchange="applyFilters()">
                                <option value="">ã™ã¹ã¦</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">ã‚¸ãƒ£ãƒ³ãƒ«</label>
                            <select class="filter-control" id="genreSelect" onchange="applyFilters()">
                                <option value="">ã™ã¹ã¦</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">é–‹å§‹æ™‚ã®ç‚¹æ•°</label>
                            <select class="filter-control" id="scoreSelect" onchange="applyFilters()">
                                <option value="">ã™ã¹ã¦</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="stats" id="statsArea"></div>
                    <div class="rankings">
                        <div class="ranking-section">
                            <div class="ranking-title up">ğŸ“ˆ ä¸Šæ˜‡ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
                            <div id="upList"></div>
                        </div>
                        <div class="ranking-section">
                            <div class="ranking-title down">ğŸ“‰ ä¸‹é™ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
                            <div id="downList"></div>
                        </div>
                    </div>
                </div>
                
                <div id="graph-content" class="tab-content">
                    <div class="filters">
                        <div class="filter-group">
                            <label class="filter-label">åº—åã§æ¤œç´¢</label>
                            <input type="text" class="filter-control" id="graphSearchBox" placeholder="åº—åã‚’å…¥åŠ›..." oninput="updateGraphFilters()">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">çœŒ</label>
                            <select class="filter-control" id="graphPrefectureSelect" onchange="updateGraphFilters()">
                                <option value="">ã™ã¹ã¦</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">ä¾¡æ ¼å¸¯</label>
                            <select class="filter-control" id="graphPriceSelect" onchange="updateGraphFilters()">
                                <option value="">ã™ã¹ã¦</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">ã‚¸ãƒ£ãƒ³ãƒ«</label>
                            <select class="filter-control" id="graphGenreSelect" onchange="updateGraphFilters()">
                                <option value="">ã™ã¹ã¦</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">é–‹å§‹æ™‚ã®ç‚¹æ•°</label>
                            <select class="filter-control" id="graphScoreSelect" onchange="updateGraphFilters()">
                                <option value="">ã™ã¹ã¦</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="canvas-container">
                        <canvas id="mainChart" width="800" height="400"></canvas>
                    </div>
                    <div class="legend" id="legendArea"></div>
                </div>
            </div>
            
            <div id="debugLog" class="debug-area"></div>
        </div>
    </div>

    <script>
        let storeData = [];
        let filteredRankingData = [];
        let filteredGraphData = [];
        const chartColors = ['#667eea', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#14b8a6'];

        function log(message) {
            const debugDiv = document.getElementById('debugLog');
            const time = new Date().toLocaleTimeString();
            debugDiv.innerHTML += '<div>[' + time + '] ' + message + '</div>';
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function parseCSV(csvText) {
            log('CSVè§£æé–‹å§‹');
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length >= headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim().replace(/^"|"$/g, '') : '';
                    });
                    data.push(row);
                }
            }
            
            log('è§£æå®Œäº†: ' + data.length + 'è¡Œ');
            return data;
        }

        function analyzeData(data) {
            log('ãƒ‡ãƒ¼ã‚¿åˆ†æé–‹å§‹');
            const groups = {};
            
            data.forEach(row => {
                const id = row['åº—èˆ—ID'];
                const name = row['åº—å'];
                const score = parseFloat(row['ç‚¹æ•°']);
                const date = row['å¹´æœˆ'];
                
                if (id && name && !isNaN(score) && date) {
                    if (!groups[id]) groups[id] = [];
                    groups[id].push({
                        id, name, score, date,
                        prefecture: row['çœŒ'] || 'ä¸æ˜',
                        genre: row['ã‚¸ãƒ£ãƒ³ãƒ«å'] || 'ä¸æ˜',
                        priceRange: row['ä¾¡æ ¼å¸¯'] || 'ä¸æ˜'
                    });
                }
            });

            const results = [];
            Object.keys(groups).forEach(id => {
                const stores = groups[id];
                if (stores.length >= 1) {
                    stores.sort((a, b) => a.date.localeCompare(b.date));
                    const first = stores[0];
                    const last = stores[stores.length - 1];
                    const diff = stores.length > 1 ? last.score - first.score : 0;
                    
                    results.push({
                        id, 
                        name: first.name,
                        prefecture: first.prefecture,
                        genre: first.genre,
                        priceRange: first.priceRange,
                        startScore: first.score,
                        endScore: last.score,
                        diff: Math.round(diff * 100) / 100,
                        startDate: first.date,
                        endDate: last.date,
                        timeSeries: stores
                    });
                }
            });
            
            results.sort((a, b) => b.diff - a.diff);
            log('åˆ†æå®Œäº†: ' + results.length + 'åº—èˆ—');
            return results;
        }

        function getGenreInfo(store) {
            return store.genre ? '[' + store.genre + ']' : '';
        }

        function displayResults(data) {
            storeData = data;
            filteredRankingData = data;
            filteredGraphData = data;
            document.getElementById('results').classList.remove('hidden');
            
            setupFilters();
            updateStats();
            displayRanking();
        }

        function setupFilters() {
            const prefectures = [...new Set(storeData.map(s => s.prefecture))].sort();
            const genres = [...new Set(storeData.map(s => s.genre))].sort();
            const priceRanges = [...new Set(storeData.map(s => s.priceRange))].filter(p => p !== 'ä¸æ˜').sort((a, b) => {
                const aNum = parseInt(a.replace(/[^\d]/g, '')) || 0;
                const bNum = parseInt(b.replace(/[^\d]/g, '')) || 0;
                return aNum - bNum;
            });
            
            const startScores = [];
            for (let i = 30; i <= 50; i++) {
                startScores.push((i / 10).toFixed(1) + 'å°');
            }
            
            function populateSelect(selectId, options) {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">ã™ã¹ã¦</option>';
                    options.forEach(option => {
                        select.innerHTML += '<option value="' + escapeHtml(option) + '">' + escapeHtml(option) + '</option>';
                    });
                }
            }
            
            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            populateSelect('prefectureSelect', prefectures);
            populateSelect('priceSelect', priceRanges);
            populateSelect('genreSelect', genres);
            populateSelect('scoreSelect', startScores);
            
            // ã‚°ãƒ©ãƒ•ç”¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            populateSelect('graphPrefectureSelect', prefectures);
            populateSelect('graphPriceSelect', priceRanges);
            populateSelect('graphGenreSelect', genres);
            populateSelect('graphScoreSelect', startScores);
        }

        function applyFilters() {
            const searchBox = document.getElementById('searchBox');
            const prefectureSelect = document.getElementById('prefectureSelect');
            const priceSelect = document.getElementById('priceSelect');
            const genreSelect = document.getElementById('genreSelect');
            const scoreSelect = document.getElementById('scoreSelect');
            
            if (!searchBox || !prefectureSelect || !priceSelect || !genreSelect || !scoreSelect) return;
            
            const searchTerm = searchBox.value.toLowerCase();
            const prefecture = prefectureSelect.value;
            const priceRange = priceSelect.value;
            const genre = genreSelect.value;
            const startScore = scoreSelect.value;
            
            filteredRankingData = storeData.filter(store => {
                if (searchTerm && !store.name.toLowerCase().includes(searchTerm)) return false;
                if (prefecture && store.prefecture !== prefecture) return false;
                if (priceRange && store.priceRange !== priceRange) return false;
                if (genre && store.genre !== genre) return false;
                if (startScore) {
                    const scoreRange = parseFloat(startScore.replace('å°', ''));
                    if (store.startScore < scoreRange || store.startScore >= scoreRange + 0.1) return false;
                }
                return true;
            });
            
            updateStats();
            displayRanking();
        }

        function updateGraphFilters() {
            const graphSearchBox = document.getElementById('graphSearchBox');
            const graphPrefectureSelect = document.getElementById('graphPrefectureSelect');
            const graphPriceSelect = document.getElementById('graphPriceSelect');
            const graphGenreSelect = document.getElementById('graphGenreSelect');
            const graphScoreSelect = document.getElementById('graphScoreSelect');
            
            if (!graphSearchBox || !graphPrefectureSelect || !graphPriceSelect || !graphGenreSelect || !graphScoreSelect) return;
            
            const searchTerm = graphSearchBox.value.toLowerCase();
            const prefecture = graphPrefectureSelect.value;
            const priceRange = graphPriceSelect.value;
            const genre = graphGenreSelect.value;
            const startScore = graphScoreSelect.value;
            
            filteredGraphData = storeData.filter(store => {
                if (searchTerm && !store.name.toLowerCase().includes(searchTerm)) return false;
                if (prefecture && store.prefecture !== prefecture) return false;
                if (priceRange && store.priceRange !== priceRange) return false;
                if (genre && store.genre !== genre) return false;
                if (startScore) {
                    const scoreRange = parseFloat(startScore.replace('å°', ''));
                    if (store.startScore < scoreRange || store.startScore >= scoreRange + 0.1) return false;
                }
                return true;
            });
            
            drawTimeSeries();
        }

        function updateStats() {
            const data = filteredRankingData;
            const improved = data.filter(s => s.diff > 0).length;
            const worsened = data.filter(s => s.diff < 0).length;
            const unchanged = data.filter(s => s.diff === 0).length;
            const avgDiff = data.length > 0 ? data.reduce((sum, s) => sum + s.diff, 0) / data.length : 0;
            
            let startDate = '', endDate = '';
            if (data.length > 0) {
                const allStartDates = data.map(s => s.startDate).filter(d => d);
                const allEndDates = data.map(s => s.endDate).filter(d => d);
                if (allStartDates.length > 0) {
                    startDate = allStartDates.sort()[0];
                    endDate = allEndDates.sort().reverse()[0];
                }
            }
            
            const periodText = startDate && endDate ? '<div style="text-align:center;margin-bottom:20px;color:#64748b;font-weight:600;">' + startDate + 'ï½' + endDate + 'ã®é›†è¨ˆçµæœ</div>' : '';
            
            const html = [
                periodText,
                '<div class="stat-card"><div class="stat-number" style="color: #667eea;">' + data.length + '</div><div class="stat-label">ç·åº—èˆ—æ•°</div></div>',
                '<div class="stat-card"><div class="stat-number" style="color: #10b981;">' + improved + '</div><div class="stat-label">æ”¹å–„åº—èˆ—æ•°</div></div>',
                '<div class="stat-card"><div class="stat-number" style="color: #ef4444;">' + worsened + '</div><div class="stat-label">æ‚ªåŒ–åº—èˆ—æ•°</div></div>',
                '<div class="stat-card"><div class="stat-number" style="color: #64748b;">' + unchanged + '</div><div class="stat-label">å¤‰åŒ–ãªã—</div></div>',
                '<div class="stat-card"><div class="stat-number" style="color: #8b5cf6;">' + avgDiff.toFixed(2) + '</div><div class="stat-label">å¹³å‡å·®åˆ†</div></div>'
            ].join('');
            
            const statsArea = document.getElementById('statsArea');
            if (statsArea) {
                statsArea.innerHTML = html;
            }
        }

        function displayRanking() {
            const upStores = filteredRankingData.filter(s => s.diff > 0);
            const downStores = filteredRankingData.filter(s => s.diff < 0);
            
            function createRankingHtml(stores, type) {
                if (stores.length === 0) {
                    return '<div style="text-align:center;color:#64748b;">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
                }
                
                return stores.map((store, index) => {
                    const scoreText = type === 'up' ? '+' + store.diff : store.diff;
                    const scoreClass = type === 'up' ? 'positive' : 'negative';
                    const genreInfo = getGenreInfo(store);
                    
                    return [
                        '<div class="ranking-item ' + type + '">',
                        '<div>',
                        '<div class="store-name">' + (index + 1) + '. ' + escapeHtml(store.name) + '</div>',
                        '<div class="store-details">',
                        escapeHtml(store.prefecture) + ' | ' + escapeHtml(store.genre) + ' | ' + escapeHtml(store.priceRange),
                        genreInfo ? '<br>ã‚¸ãƒ£ãƒ³ãƒ«: ' + escapeHtml(genreInfo) : '',
                        '<br>' + store.startScore + ' â†’ ' + store.endScore + ' (' + store.startDate + 'ï½' + store.endDate + ')',
                        '</div>',
                        '</div>',
                        '<div class="score-change ' + scoreClass + '">' + scoreText + '</div>',
                        '</div>'
                    ].join('');
                }).join('');
            }
            
            const upList = document.getElementById('upList');
            const downList = document.getElementById('downList');
            
            if (upList) upList.innerHTML = createRankingHtml(upStores, 'up');
            if (downList) downList.innerHTML = createRankingHtml(downStores, 'down');
        }

        function drawTimeSeries() {
            const canvas = document.getElementById('mainChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const margin = { top: 40, right: 180, bottom: 80, left: 60 };
            const width = canvas.width - margin.left - margin.right;
            const height = canvas.height - margin.top - margin.bottom;
            
            const validStores = filteredGraphData.filter(store => store.timeSeries && store.timeSeries.length > 1);
            
            if (validStores.length === 0) {
                ctx.fillStyle = '#64748b';
                ctx.font = '16px system-ui';
                ctx.textAlign = 'center';
                ctx.fillText('æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // å…¨åº—èˆ—ã®å…¨æ—¥ä»˜ã‚’åé›†ã—ã¦ã‚½ãƒ¼ãƒˆ
            const allDates = [];
            validStores.forEach(store => {
                store.timeSeries.forEach(point => {
                    if (!allDates.includes(point.date)) {
                        allDates.push(point.date);
                    }
                });
            });
            allDates.sort();
            
            if (allDates.length === 0) return;
            
            // è»¸æç”»
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(margin.left, margin.top);
            ctx.lineTo(margin.left, margin.top + height);
            ctx.lineTo(margin.left + width, margin.top + height);
            ctx.stroke();
            
            // Yè»¸ç›®ç››ã‚Šï¼ˆ3.0ï½4.0ã®ç¯„å›²ã€0.05åˆ»ã¿ï¼‰
            ctx.fillStyle = '#64748b';
            ctx.font = '11px system-ui';
            ctx.textAlign = 'right';
            for (let score = 3.0; score <= 4.0; score += 0.05) {
                const y = margin.top + height - (score - 3.0) / 1.0 * height;
                
                // ãƒ¡ã‚¸ãƒ£ãƒ¼ã‚°ãƒªãƒƒãƒ‰ï¼ˆ0.1åˆ»ã¿ï¼‰ã¨ãƒã‚¤ãƒŠãƒ¼ã‚°ãƒªãƒƒãƒ‰ï¼ˆ0.05åˆ»ã¿ï¼‰ã‚’åŒºåˆ¥
                if (Math.abs(score % 0.1) < 0.001) {
                    // ãƒ¡ã‚¸ãƒ£ãƒ¼ã‚°ãƒªãƒƒãƒ‰ - ãƒ©ãƒ™ãƒ«è¡¨ç¤º
                    ctx.fillText(score.toFixed(1), margin.left - 10, y + 4);
                    ctx.strokeStyle = '#e2e8f0';
                    ctx.lineWidth = 1;
                } else {
                    // ãƒã‚¤ãƒŠãƒ¼ã‚°ãƒªãƒƒãƒ‰ - ãƒ©ãƒ™ãƒ«ãªã—ã€è–„ã„ç·š
                    ctx.strokeStyle = '#f1f5f9';
                    ctx.lineWidth = 0.5;
                }
                
                ctx.beginPath();
                ctx.moveTo(margin.left, y);
                ctx.lineTo(margin.left + width, y);
                ctx.stroke();
            }
            
            // Xè»¸ã®æ—¥ä»˜ãƒ©ãƒ™ãƒ«ï¼ˆé–“å¼•ã„ã¦è¡¨ç¤ºï¼‰
            ctx.fillStyle = '#64748b';
            ctx.font = '9px system-ui';
            ctx.textAlign = 'center';
            
            // æ—¥ä»˜ã‚’é–“å¼•ã„ã¦è¡¨ç¤ºï¼ˆ5å€‹ã”ã¨ç¨‹åº¦ï¼‰
            const dateStep = Math.max(1, Math.floor(allDates.length / 12));
            for (let i = 0; i < allDates.length; i += dateStep) {
                const x = margin.left + (i / (allDates.length - 1)) * width;
                const dateStr = allDates[i];
                
                // æ—¥ä»˜ã‚’çŸ­ç¸®è¡¨ç¤ºï¼ˆMM-DDå½¢å¼ï¼‰
                const shortDate = dateStr.length >= 10 ? dateStr.substring(5, 10) : dateStr;
                
                ctx.save();
                ctx.translate(x, margin.top + height + 25);
                ctx.rotate(-Math.PI / 6); // 30åº¦å›è»¢
                ctx.fillText(shortDate, 0, 0);
                ctx.restore();
            }
            
            // ã™ã¹ã¦ã®æ—¥ä»˜ã«å¯¾ã—ã¦è–„ã„ã‚°ãƒªãƒƒãƒ‰ç·š
            for (let i = 0; i < allDates.length; i++) {
                const x = margin.left + (i / (allDates.length - 1)) * width;
                ctx.strokeStyle = '#fafafa';
                ctx.lineWidth = 0.3;
                ctx.beginPath();
                ctx.moveTo(x, margin.top);
                ctx.lineTo(x, margin.top + height);
                ctx.stroke();
            }
            
            let legendHtml = '';
            
            // å…¨åº—èˆ—ã®ç·šã‚’æç”»
            validStores.forEach((store, index) => {
                const color = chartColors[index % chartColors.length];
                
                // é€æ˜åº¦ã‚’è¿½åŠ ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ãªç·šã«
                ctx.strokeStyle = color;
                ctx.globalAlpha = 0.8;
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                // å®Ÿéš›ã®æ—¥ä»˜ã«åŸºã¥ã„ã¦ç·šã‚’æç”»
                ctx.beginPath();
                let firstPoint = true;
                
                store.timeSeries.forEach((point) => {
                    const dateIndex = allDates.indexOf(point.date);
                    if (dateIndex === -1) return;
                    
                    const x = margin.left + (dateIndex / (allDates.length - 1)) * width;
                    // 3.0ï½3.7ã®ç¯„å›²ã§ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´
                    const y = margin.top + height - Math.max(0, Math.min(1, (point.score - 3.0) / 0.7)) * height;
                    
                    if (firstPoint) {
                        ctx.moveTo(x, y);
                        firstPoint = false;
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // é€æ˜åº¦ã‚’ãƒªã‚»ãƒƒãƒˆ
                ctx.globalAlpha = 1.0;
                
                // å‡¡ä¾‹ã«åº—åã®ã¿è¿½åŠ 
                const displayName = store.name.length > 25 ? store.name.substring(0, 25) + '...' : store.name;
                legendHtml += '<div class="legend-item">' +
                    '<div class="legend-color" style="background:' + color + ';"></div>' +
                    escapeHtml(displayName) +
                    '</div>';
            });
            
            const legendArea = document.getElementById('legendArea');
            if (legendArea) {
                legendArea.innerHTML = legendHtml;
            }
        }

        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            
            if (tabName === 'ranking') {
                const rankingTab = document.querySelector('.tab[onclick="switchTab(\'ranking\')"]');
                const rankingContent = document.getElementById('ranking-content');
                if (rankingTab) rankingTab.classList.add('active');
                if (rankingContent) rankingContent.classList.add('active');
            } else if (tabName === 'graph') {
                const graphTab = document.querySelector('.tab[onclick="switchTab(\'graph\')"]');
                const graphContent = document.getElementById('graph-content');
                if (graphTab) graphTab.classList.add('active');
                if (graphContent) graphContent.classList.add('active');
                if (storeData.length > 0) {
                    updateGraphFilters();
                }
            }
        }

        function handleFileUpload(file) {
            if (!file || !file.name.toLowerCase().endsWith('.csv')) {
                log('ã‚¨ãƒ©ãƒ¼: CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            log('CSVãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹: ' + file.name);
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    const parsed = parseCSV(csvText);
                    const analyzed = analyzeData(parsed);
                    displayResults(analyzed);
                    log('ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†å®Œäº†: ' + analyzed.length + 'åº—èˆ—');
                } catch (error) {
                    log('ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + error.message);
                    console.error(error);
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('åº—èˆ—åˆ†æã‚¢ãƒ—ãƒªï¼ˆä¿®æ­£ç‰ˆï¼‰åˆæœŸåŒ–å®Œäº†');
            log('âœ… ã‚°ãƒ©ãƒ•ç¯„å›²: 3.0-4.0');
            log('âœ… æ»‘ã‚‰ã‹ãªãƒ™ã‚¸ã‚§æ›²ç·šã‚°ãƒ©ãƒ•');
            log('âœ… ã‚¸ãƒ£ãƒ³ãƒ«è¡¨ç¤ºæ©Ÿèƒ½');
            log('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„');
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        handleFileUpload(e.target.files[0]);
                    }
                });
            }
        });
    </script>
</body>
</html>